<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #f5f5f5;
        }

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
        }

        input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover {
            background: #45a049;
        }

        .error {
            color: #f44336;
            margin-top: 1rem;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="login-box">
        <h1>Acesso ao Sistema</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="email">E-mail:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit">Entrar</button>
            <div id="error" class="error"></div>
        </form>
    </div>

    <script>
                // 1. INTERCEPTOR PARA ADICIONAR TOKEN AUTOMATICAMENTE
        // Adicione este c√≥digo no in√≠cio do seu arquivo JavaScript
        (function() {
    const originalFetch = window.fetch;
    
    window.fetch = async function(...args) {
        const [url, options = {}] = args;
        
        // Verificar se √© uma requisi√ß√£o para nossa API
        const API_URL = 'https://c1b8d2bcf4e1.ngrok-free.app';
        const isApiRequest = url.includes(API_URL) || url.startsWith('/');
        
        if (isApiRequest) {
            const token = localStorage.getItem('access_token');
            
            // Configurar headers padr√£o
            options.headers = {
                ...options.headers,
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            };
            
            // Adicionar token se existir
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
                console.log('‚úÖ Token adicionado √† requisi√ß√£o:', url);
            }
            
            // Incluir credenciais
            options.credentials = 'include';
            options.mode = 'cors';
        }
        
        return originalFetch.call(this, url, options);
    };
})();

        async function safeFetch(url, options = {}) {
    try {
        // Fazer a requisi√ß√£o
        const response = await fetch(url, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                ...options.headers
            },
            credentials: 'include',
            ...options
        });

        // Verificar se response √© v√°lido
        if (!response) {
            throw new Error('Nenhuma resposta recebida do servidor');
        }

        // Verificar se headers existe
        if (!response.headers) {
            throw new Error('Resposta sem headers do servidor');
        }

        // Verificar tipo de conte√∫do
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            
            if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                throw new Error(`Servidor retornou HTML em vez de JSON. Status: ${response.status}`);
            }
            
            throw new Error(`Resposta inesperada: ${contentType}. Status: ${response.status}`);
        }
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
        
    } catch (error) {
        console.error('Erro no safeFetch:', error);
        throw error; // Re-lan√ßar o erro para ser tratado pelo chamador
    }
}

        // 2. C√ìDIGO DE LOGIN ATUALIZADO
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('error');

    try {
        const API_URL = 'https://c1b8d2bcf4e1.ngrok-free.app';

        // CORRE√á√ÉO: Usar OAuth2PasswordRequestForm corretamente
        const formData = new URLSearchParams();
        formData.append('username', email);  // O campo deve ser 'username', n√£o 'email'
        formData.append('password', password);
        formData.append('grant_type', 'password');  // Adicionar grant_type

        console.log('üì§ Enviando dados:', Object.fromEntries(formData));

        const response = await fetch(`${API_URL}/token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData.toString(),  // Converter para string
            credentials: 'include'
        });

        console.log('üì• Resposta recebida. Status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Erro na resposta:', errorText);
            throw new Error(errorText || `HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log('‚úÖ Login bem-sucedido. Dados:', data);

        const { access_token, token_type } = data;

        // Armazena o token no localStorage
        localStorage.setItem('access_token', access_token);
        localStorage.setItem('token_type', token_type);

        console.log('‚úÖ Token armazenado no localStorage');

        // Testar o token imediatamente
        try {
            const testResponse = await fetch(`${API_URL}/users/me/`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${access_token}`,
                    'Accept': 'application/json'
                },
                credentials: 'include'
            });

            console.log('üß™ Teste do token. Status:', testResponse.status);

            if (testResponse.ok) {
                const userData = await testResponse.json();
                console.log('‚úÖ Token v√°lido! Usu√°rio:', userData.email);
                
                // Redirecionar ap√≥s login bem-sucedido
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } else {
                const errorText = await testResponse.text();
                throw new Error(`Teste falhou: ${errorText}`);
            }
        } catch (testError) {
            console.warn('‚ö†Ô∏è Teste do token falhou:', testError);
            throw testError;
        }

    } catch (error) {
        console.error('‚ùå Erro no login:', error);
        
        // Mostrar mensagem de erro mais amig√°vel
        try {
            const errorObj = JSON.parse(error.message);
            if (errorObj.detail) {
                errorDiv.textContent = 'Email ou senha inv√°lidos';
            } else {
                errorDiv.textContent = error.message;
            }
        } catch {
            errorDiv.textContent = error.message || 'Erro ao fazer login';
        }
    }
});

        // 3. VERIFICA√á√ÉO AUTOM√ÅTICA DE AUTENTICA√á√ÉO
        // Adicione este c√≥digo em todas as p√°ginas protegidas
        document.addEventListener('DOMContentLoaded', function() {
    if (window.location.pathname.includes('login.html')) return;

    const token = localStorage.getItem('access_token');
    const API_URL = 'https://c1b8d2bcf4e1.ngrok-free.app';

    if (!token) {
        console.log('‚ùå Nenhum token encontrado, redirecionando para login...');
        window.location.href = 'login.html';
        return;
    }

    // Verificar token
    fetch(`${API_URL}/users/me/`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
        },
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Token inv√°lido');
        }
        return response.json();
    })
    .then(userData => {
        console.log('‚úÖ Usu√°rio autenticado:', userData.email);
    })
    .catch(error => {
        console.error('‚ùå Erro de autentica√ß√£o:', error);
        localStorage.removeItem('access_token');
        window.location.href = 'login.html';
    });
});

        // 4. FUN√á√ÉO UTILIT√ÅRIA PARA REQUISI√á√ïES API
        // Use esta fun√ß√£o para todas as chamadas API
        async function apiRequest(endpoint, options = {}) {
    const API_URL = 'https://c1b8d2bcf4e1.ngrok-free.app';
    const token = localStorage.getItem('access_token');

    const config = {
        ...options,
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            ...options.headers,
        },
        credentials: 'include',
        mode: 'cors'
    };

    if (token) {
        config.headers['Authorization'] = `Bearer ${token}`;
    }

    try {
        const response = await fetch(`${API_URL}${endpoint}`, config);
        
        if (response.status === 401) {
            localStorage.removeItem('access_token');
            window.location.href = 'login.html';
            throw new Error('Sess√£o expirada');
        }

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || `HTTP ${response.status}`);
        }

        // Verificar se a resposta tem conte√∫do
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return await response.json();
        }
        
        return await response.text();
    } catch (error) {
        console.error('Erro na requisi√ß√£o API:', error);
        throw error;
    }
}

        // 5. EXEMPLO DE USO DA FUN√á√ÉO API
        // Em vez de fetch direto, use:
        /*
        // Para GET
        apiRequest('/records/')
            .then(data => console.log(data))
            .catch(error => console.error(error));
        
        // Para POST
        apiRequest('/records/', {
            method: 'POST',
            body: JSON.stringify({ name: 'Novo registro' })
        });
        */
    </script>
</body>

</html>